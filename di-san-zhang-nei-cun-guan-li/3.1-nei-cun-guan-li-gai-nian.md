# 3.1 内存管理概念

## 3.1.0 内存相关概念

程序执行前需要先放到内存中才能被CPU处理。内存是为了缓和CPU与外存之间的速度矛盾。

内存地址从0开始，每一个地址对应一个**存储单元**（用于存放数据的最小单元）。

* 若计算机按字节编址，则每个存储单元大小为一字节（1B），即8个二进制位；
* 若计算机按字编址，且字长为16位，则存储单元大小为一个字长，即16个二进制位。

> * $$2^{10}$$个字节：1K
> * $$2^{20}$$个字节：1M
> * $$2^{30}$$个字节：1G

## 3.1.1 内存管理的基本原理和要求

### 1、逻辑地址与物理地址

**逻辑地址**：相对于进程的起始地址而言的地址

**物理地址**：实际在内存中的地址

在程序中，一般使用的是逻辑地址。

### 2、程序的装入和链接

创建进程时，通常需要将程序和数据装入内存，这一过程通常包含以下几个步骤：

* **编译**：将高级语言翻译为机器语言，形成一组**目标模块**
* **链接**：将编译后的的目标模块与所需的静态库一起，形成一个完整的**装入模块**
  * **静态链接**：在程序执行前将各目标模块及其所需库函数组成一个完整的装入模块
  * **装入时动态链接**：在各目标模块装入时，一边装入一边链接
  * **运行时动态链接**：在程序执行到相应目标模块时，才进行链接
    * 便于修改和更新
    * 便于实现对目标模块的共享
* **装入**：将装入模块装入内存运行（逻辑地址 ——&gt; 物理地址）
  * **绝对装入**：若已经知道程序将在内存的哪个位置运行，则编译时就将逻辑地址转换为物理地址
    * 灵活性很差，只适用于单道程序环境
  * **静态重定位（可重定位装入）**：对所有的逻辑单元进行重定位，将其转化为物理地址
    * 必须要一次全部装入内存（一次分配所需的全部内存）
    * 逻辑地址必须是连续的
    * 程序运行期间不能再次移动
  * **动态重定位（动态运行时装入）**：设置一个**重定位寄存器**，里面存放程序的起始地址。程序运行时，会将逻辑地址与重定位寄存器中的值相加得到物理地址
    * 允许程序在内存中移动
    * 可以分配到不连续的区域中
    * 可以动态的分配内存

### 3、内存管理的功能

* **内存空间的分配与回收**：主存储器空间的分配与管理
* **地址转换**：逻辑地址到物理地址
* **内存空间的扩展**：虚拟化
* **存储保护**：保护各个作业只能访问自己的内存空间

### 4、内存保护

* 设置**上、下限寄存器**，进行越界检测
* 通过**重定位寄存器**和**界地址寄存器**，进行越界检测。其中重定位寄存器存放**起始物理地址**，界地址寄存器存放**最大逻辑地址**。

## 3.1.2 覆盖与交换

### 1、覆盖技术

将用户空间分为一个**固定区**和若干**覆盖区**。

常用的部分放入固定区，不常用的段在需要时放入覆盖区，当需要使用时将相应的段从外存调入覆盖区。

* 内存中能够更新的地方只有覆盖区的部分
* 对用户不透明

### 2、交换技术

当内存空间紧张时，将内存中的某些进程暂时**换出**到外存，并将外存中某些已经具备运行条件的进程**换入**内存。

{% hint style="danger" %}
PCB是常驻内存的
{% endhint %}

中级调度（内存调度）就是决定将哪个处于挂起状态的进程重新换入内存。

* 在具有交换功能的操作系统中，磁盘空间通常分为**文件区**和**对换区**
  * 文件区存储文件，追求磁盘空间的利用率，对磁盘空间的管理采用离散分配方式
  * 对换区占用空间很小，追求换入换出速度，对磁盘空间的管理采用连续分配方式
* 交换通常发生在有较多进程在运行且内存吃紧的时刻
* 当系统负荷降低时停止交换
* 一般会优先换出**阻塞进程**以及**底优先级的进程**，同时为了防止出现饥饿现象，有时还要考选进程在内存的驻留时间

## 3.1.3 连续分配管理方式

连续分配：系统为用户进程分配的必须是一个**连续的内存空间**

### 1、单一连续分配

在单一连续分配方式中，内存被分为系统区和用户区。

* 系统区通常位于内存的低地址部分，用于存放操作系统相关数据；
* 用户区用于存放用户进程相关数据。

内存中只能有一道用户程序，用户程序独占整个用户区空间。

* 优点：
  * 实现简单；
  * 无外部碎片；
  * 可以采用覆盖技术扩充内存；
  * 不一定需要采取内存保护（eg: 早期的PC操作 系统MS-DOS）
* 缺点：
  * 只能用于单用户、单任务的操作系统中；
  * 有**内部碎片**；
  * 存储器利用率极低。

{% hint style="info" %}
内部碎片：系统分配给进程的内存空间中，没有被利用到的区域
{% endhint %}

### 2、固定分区分配

将整个用户空间划分为若千个**固定大小**的分区，在每个分区中只装入一道作业。

* 分区大小相等：
  * 缺乏灵活性
  * 适合用于用一台计算机控制多个相同对象的场合
* 分区大小不等：
  * 增加了灵活性，可以满足不同大小的进程需求；
  * 根据常在系统中运行的作业大小情况进行划分 （比如：划分多个小分区、适量中等分区+少量大分区）

