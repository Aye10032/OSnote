# 4.2 文件的系统实现

## 4.2.1 文件的物理结构

{% hint style="warning" %}
即文件分配方式，对应书4.2.3
{% endhint %}

**磁盘块**：类似于**内存分页**，磁盘中的存储单元也会被分为一个个**块/磁盘块/物理块**。很多操作系统中，**磁盘块的大小与内存块、页面的大小相同**。

**文件块**：在外存管理中为了方便对文件数据的管理，与内存管理相似的，**文件的逻辑地址空间**也被分为了一个一个的文件块。

文件的逻辑地址也可以表示为（_逻辑块号，块内地址_）的形式。

### 1、连续分配

连续分配方式要求每个文件在磁盘上占有**一组连续的块**。

在文件目录中记录存放的**起始块号**和**长度** 。因此只需要找到相应的FCB，即可找到对应的文件。

$$
物理块号 = 起始块号 + 逻辑块号(用户给出)
$$

* 优点
  * 支持顺序访问
  * 支持直接（随机）访问
  * 在顺序读/写时速度最快（磁道挨着，磁头移动距离最短）
* 缺点
  * 不方便文件的拓展
  * 存储空间利用率低，会产生磁盘碎片

### 2、链接分配

链接分配采取离散分配的方式，可以为文件分配离散的磁盘块。

#### （1）隐式链接

目录中记录了文件存放的**起始块号**和**结束块号**。除了文件的最后一个磁盘块之外，每个磁盘块中都会保存指向下一个盘块的指针，这些指针对用户是透明的。同时，在文件目录中包含了第一块和最后一块的指针。

要访问某个磁盘块，需要顺序的访问它前面的所有磁盘块来指向它。

* 优点
  * 方便文件拓展
  * 不会产生碎片
* 缺点
  * 只支持顺序存储，不支持随机存储
  * 指向下一个磁盘块的指针会占用少量空间

#### （2）显式链接

把用于链接文件各物理块的指针**显式地**存放在一张表中。即文**件分配表**（FAT，File Allocation Table）。

FAT中存放了物理块号和这个物理块指向的下一个物理块号。一个磁盘仅设一张FAT，开机时读入并在之后常驻内存。其各个表项在物理上连续存储（即实际硬盘中的依次各物理块），表长相同，因此物理块号是隐含的。

* 优点
  * 方便文件拓展
  * 不会产生碎片
  * 支持随机存储
  * 地址转换不需要访问磁盘（FAT存储在内存中，查询不需要进行IO操作）
* 缺点
  * FAT需要占用一定的空间

{% hint style="danger" %}
题目中没有说则默认为隐式链接
{% endhint %}

### 3、索引分配

索引分配允许文件离散地分配在各个磁盘块中，系统会为**每个文件建立一张索引表**，索引表中记录了文 件的各个逻辑块对应的物理块（类似于内存管理中的页表，建立逻辑页面到物理页之间的映射关系\)。

索引表存放的磁盘块称为**索引块**。文件数据存放的磁盘块称为**数据块**。

访问时，先通过FCB找到文件的索引块地址，再根据逻辑地址查找索引块得到实际磁盘块。

* 优点
  * 支持随机存储
  * 易于拓展
* 缺点
  * 索引表占用一定的空间
  * 访问数据块前需要先读入索引块
  * 可能需要多次磁盘读取操作

当文件很大，索引表一个物理块装不下时，有三种处理方案：

#### （1）链接方案

如果索引表太大，一个索引块装不下，那么可以将多个索引块链接起来存放。FCB中只需要存放第一个索引块的地址即可。

要查找一个块，需要将前面的所有索引表都查找一遍，效率低下。

#### （2）多层索引

建立多层索引，使第一层索引块指向第二层的索引块。还可根据 文件大小的要求再建立第三层、第四层索引块。

{% hint style="info" %}
例：假设磁盘块大小为1KB，一个索引表项占4B，则一个 磁盘块只能存放256个索引项。

若某文件采用两层索引，则该文件的最大长度可以到 

$$256 \times 256 \times 1 \text{KB} = 65536 \text{KB}  = 64 \text{MB}$$
{% endhint %}

**以两层为例**，访问地址时，先访问FCB找到顶级索引表，根据逻辑地址计算出二级索引表的块号，访问二级索引表，并查询得到物理块号，**共计三次IO访问**。

* 缺点
  * 即使是小文件，也需要经过K+1次读磁盘（K为索引层数）

#### （3）混合索引

多种索引分配方式的结合。例如，一个文件的顶级索引表中，既包含直接地址索引（直接指向数据块），又包含一级间接索引（指向单层索引表），还包含两级间接索引（指向两层索引表） 。

解决了小文件读磁盘次数过多的问题。

{% hint style="danger" %}
做题时注意条件中顶级索引块是否已经调入内存。
{% endhint %}

## 4.2.2 文件的存储空间管理

### 1、存储空间的划分与初始化

* 存储空间的划分：将物理磁盘划分为一个个文件卷（逻辑卷、逻辑盘）
* 存储空间的初始化：将各个文件卷划分为目录区、文件区
  * 目录区：存放FCB、用于磁盘空间管理的相关信息
  * 文件区：存放文件数据

### 2、存储空间的管理

文件存储设备的管理实质上就是对空闲块的组织和管理

#### （1）空闲表法



